<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    window.TRACKS_ENDPOINT = "{{ url_for('api_tracks', filename=filename) }}";
    window.VIDEO_URL = "{{ url_for('serve_upload', filename=filename) }}";
    window.STUDENT_MAP = {{ student_map|tojson|safe }};
  </script>
  <script defer src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
<nav class="navbar navbar-dark bg-primary">
  <div class="container">
    <span class="navbar-brand">Video Viewer</span>
    <div class="d-flex gap-2">
      <a class="btn btn-light btn-sm" href="{{ url_for('change_password') }}">Change Password</a>
      <a class="btn btn-light btn-sm" href="{{ url_for('faculty_dashboard') }}">Back</a>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div id="playerWrap" class="card p-2 viewer">
    <video id="player" controls playsinline preload="auto" autoplay muted style="max-width:100%;" loop>
      <source src="{{ url_for('serve_upload', filename=filename) }}" type="video/mp4">
      Your browser cannot play this file. Download instead:
      <a href="{{ url_for('serve_upload', filename=filename) }}">Download</a>
    </video>
    <canvas id="overlay"></canvas>
    <div id="tooltip" class="tooltip"></div>
  </div>

  <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
    <button id="btnPlay" class="btn btn-success btn-sm"><i class="fas fa-play"></i> Play</button>
    <button id="btnPause" class="btn btn-warning btn-sm"><i class="fas fa-pause"></i> Pause</button>
    <button id="btnStop" class="btn btn-danger btn-sm"><i class="fas fa-stop"></i> Stop</button>
    <button id="btnReplay" class="btn btn-secondary btn-sm"><i class="fas fa-rotate-right"></i> Replay</button>
    <div class="form-check ms-2">
      <input class="form-check-input" type="checkbox" id="chkLoop" checked>
      <label class="form-check-label" for="chkLoop">Loop</label>
    </div>
    <div class="form-check ms-2">
      <input class="form-check-input" type="checkbox" id="chkMute" checked>
      <label class="form-check-label" for="chkMute">Mute</label>
    </div>
    <div class="ms-3">
      <span class="badge bg-success" id="faceCount">
        <i class="fas fa-users"></i> <span id="faceCountText">Loading...</span> faces detected
      </span>
    </div>
    <div class="ms-3">
      <span class="badge bg-info" id="timeInfo">
        <i class="fas fa-clock"></i> <span id="timeInfoText">00:00</span>
      </span>
    </div>
    <div class="ms-3">
      <button id="btnRefresh" class="btn btn-outline-primary btn-sm">
        <i class="fas fa-sync-alt"></i> Refresh Face Detection
      </button>
    </div>
  </div>

  <div class="small text-muted mt-2">
    <div class="alert alert-info">
      <h6><i class="fas fa-info-circle"></i> Face Detection Features:</h6>
      <ul class="mb-0">
        <li><strong>Green Boxes:</strong> All detected faces are highlighted with green boxes</li>
        <li><strong>Hover for Details:</strong> Move your mouse over any green box to see student information</li>
        <li><strong>Click Registration Number:</strong> Click on the registration number in the tooltip to view the student's full profile</li>
        <li><strong>Real-time Tracking:</strong> Faces are tracked across video frames for continuous identification</li>
      </ul>
    </div>
  </div>
  

</div>

<script>
  // Video error handling
  document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('player');
    if (video) {
      video.addEventListener('error', function(e) {
        console.error('Video error:', e);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.innerHTML = `
          <h5><i class="fas fa-exclamation-triangle"></i> Video Loading Error</h5>
          <p>The video could not be loaded. This might be due to:</p>
          <ul>
            <li>Unsupported video format</li>
            <li>File corruption</li>
            <li>Browser compatibility issues</li>
          </ul>
          <p><a href="${video.querySelector('source').src}" class="btn btn-primary" download>
            <i class="fas fa-download"></i> Download Video Instead
          </a></p>
        `;
        document.querySelector('.container').appendChild(errorDiv);
      });
      
      video.addEventListener('loadeddata', function() {
        console.log('Video loaded successfully');
      });
      
      video.addEventListener('canplay', function() {
        console.log('Video can start playing');
      });
    }
  });


</script>
</body>
</html>
